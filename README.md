# RectifiedHR â€“ High-Resolution Diffusion via Energy Profiling and Adaptive Guidance Scheduling
[![arXiv](https://img.shields.io/badge/arXiv-2506.18208-b31b1b.svg)](https://arxiv.org/abs/2507.09441)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)

A research project focused on improving high-resolution image quality generated by latent diffusion models (Stable Diffusion 1.5) through energy profiling and adaptive guidance scheduling.

## ğŸ¯ Project Goal

To analyze and improve high-resolution image quality generated by latent diffusion via:
- Measuring latent energy evolution across denoising steps
- Proposing rectified/adaptive guidance schedules (dynamic CFG)
- Producing visually and quantitatively better high-res images

## ğŸ“¦ Deliverables
- **Paper**: LaTeX source and PDF in `paper/`
- **Figures**: All referenced images in `paper/figures/`
- **Reproducible Experiments**: Scripts and configs to regenerate results

## ğŸ—‚ï¸ Project Structure
```
RectifiedHR/
â”œâ”€â”€ master_runner.py              # Comprehensive experimental pipeline
â”œâ”€â”€ run_experiments.py            # Legacy experiment runner
â”œâ”€â”€ run_single_experiment.py      # Research figure generation
â”œâ”€â”€ src/                          # Core implementation
â”‚   â”œâ”€â”€ generate.py               # Baseline image generation  
â”‚   â”œâ”€â”€ adaptive_cfg.py           # Adaptive CFG scheduling
â”‚   â”œâ”€â”€ energy_profiling.py       # Energy analysis & research plots
â”‚   â”œâ”€â”€ enhanced_metrics.py       # Comprehensive evaluation metrics
â”‚   â”œâ”€â”€ unified_pipeline.py       # Multi-model pipeline (SD 1.5/SDXL/SD 2.1)
â”‚   â”œâ”€â”€ experiment_config.py      # 37 experimental configurations
â”‚   â””â”€â”€ metrics.py                # Image quality evaluation
â”œâ”€â”€ utils/                        # Helper functions and plotting
â”‚   â””â”€â”€ plotting.py               # Visualization utilities
â”œâ”€â”€ experiments/                  # Generated results and analysis
â”‚   â”œâ”€â”€ baseline/                 # Baseline images (219 images)
â”‚   â”œâ”€â”€ adaptive_cfg/             # Adaptive CFG results (40 images)
â”‚   â”œâ”€â”€ energy_plots/             # Research figures for paper
â”‚   â”œâ”€â”€ revision_results/         # Enhanced experimental results
â”‚   â””â”€â”€ comprehensive_results.json # Complete experimental data
â”œâ”€â”€ paper/                        # LaTeX source and figures
â”‚   â”œâ”€â”€ paper.tex                 # Main LaTeX document
â”‚   â”œâ”€â”€ rectifiedhr.pdf           # Compiled paper
â”‚   â””â”€â”€ figures/                  # Curated figures for publication
â”œâ”€â”€ IMAGES_GUIDE.md               # Guide to generated images
â”œâ”€â”€ requirements.txt              # Python dependencies
â”œâ”€â”€ LICENSE
â””â”€â”€ README.md
```

## ğŸš€ Getting Started

### Quick Setup
1. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Run comprehensive research experiments:**
   ```bash
   # Generate all paper figures and analysis
   python run_single_experiment.py
   ```

3. **Run specific experiment configurations:**
   ```bash
   # Execute all 37 experimental configurations
   python master_runner.py
   
   # Run individual baseline generation
   python src/generate.py --comprehensive
   
   # Run adaptive CFG experiments
   python src/adaptive_cfg.py --schedule_type cosine_ramp --cfg_scale 7.0
   ```

### Advanced Usage

#### Comprehensive Research Pipeline
The project includes a complete experimental pipeline for research reproduction:

```bash
# 1. Generate baseline comparisons (SD 1.5, SDXL, SD 2.1)
python master_runner.py --phase baseline

# 2. Run adaptive CFG experiments with all schedules
python master_runner.py --phase adaptive

# 3. Ultra-high resolution experiments (up to 4K)
python master_runner.py --phase ultra_high_res

# 4. Cross-model validation
python master_runner.py --phase cross_model

# 5. Enhanced metrics evaluation
python master_runner.py --phase enhanced_metrics

# 6. Generate research figures
python master_runner.py --phase research_figures
```

#### Individual Components
```bash
# Generate baseline images with specific parameters
python src/generate.py --prompt "A beautiful landscape" --cfg_scale 7.0 --sampler ddim --resolution 512

# Run adaptive CFG with custom schedule
python src/adaptive_cfg.py --prompt "A futuristic city" --schedule_type linear_decreasing --base_cfg 10.0

# Evaluate metrics on generated images  
python src/enhanced_metrics.py --input_dir experiments/baseline --output_dir experiments/evaluation

# Create energy analysis plots
python src/energy_profiling.py --data_dir experiments/baseline --output_dir experiments/energy_plots
```

### Cluster/HPC Usage
For cluster environments with GPU nodes:

```bash
# On login node: install packages
pip install torch==2.0.1+cu118 torchvision==0.15.2+cu118 --extra-index-url https://download.pytorch.org/whl/cu118

# On compute node: load modules and run
module load gcc11/11.3.0 cuda11.2/toolkit/11.2.2 cudnn8.1-cuda11.2/8.1.1.33
source venv/bin/activate
python master_runner.py --phase all
```


## ï¿½ Experimental Configurations

The project implements **37 comprehensive experimental configurations**:

### Core Experiments (27 configurations)
- **Models**: Stable Diffusion 1.5  
- **Resolutions**: 512Ã—512, 768Ã—768, 1024Ã—1024
- **CFG Scales**: 3.0, 5.0, 7.0, 10.0, 12.0, 15.0, 18.0
- **Samplers**: DDIM, Euler-A, DPM++ 2M
- **Prompts**: 200 diverse prompts across 8 categories
- **Seeds**: 5 different seeds per configuration

### SDXL Experiments (2 configurations)  
- **Model**: SDXL-1.0
- **Resolutions**: 1024Ã—1024, 1536Ã—1536
- **Advanced prompt engineering and refiner integration

### Ultra-High Resolution (4 configurations)
- **Resolutions**: 2048Ã—2048, 2560Ã—2560, 3072Ã—3072, 4096Ã—4096
- **Memory-optimized generation techniques**
- **Quality preservation at extreme resolutions**

### Cross-Model Validation (4 configurations)
- **Models**: SD 1.5, SDXL, SD 2.1
- **Comparative analysis across architectures**
- **Consistency evaluation of adaptive CFG benefits**

### Adaptive CFG Schedules
- **Cosine Ramp**: Smooth increase following cosine curve
- **Cosine Inverse**: Smooth decrease with cosine falloff  
- **Linear Increasing**: Linear ramp from low to high CFG
- **Linear Decreasing**: Linear decay from high to low CFG
- **Step Function**: Discrete CFG changes at specific steps

## ï¿½ğŸ“Š Results
- Improved high-resolution image quality (up to 4096Ã—4096)
- Reduced artifacts and improved detail across all resolutions
- Quantitative improvements in CLIP, LPIPS, and MS-SSIM scores
- Energy trajectory analysis showing stabilization
- Cross-model validation of adaptive CFG effectiveness
- Enhanced energy stability metrics and correlation analysis

## ï¿½ Evaluation Metrics

### Image Quality Metrics
- **CLIP Similarity**: Semantic alignment between prompt and generated image
- **LPIPS**: Learned Perceptual Image Patch Similarity  
- **MS-SSIM**: Multi-Scale Structural Similarity Index
- **Traditional Metrics**: PSNR, SSIM for pixel-level comparison

### Energy Analysis Metrics  
- **Energy Stability**: Variance reduction in latent energy evolution
- **Total Variation**: Smoothness of energy trajectories
- **Correlation Analysis**: Relationship between energy patterns and image quality
- **Final Energy Values**: Convergence analysis of denoising process

### Comparative Analysis
- **Cross-Resolution**: Quality preservation across different image sizes
- **Cross-Model**: Consistency of benefits across SD variants  
- **Cross-Schedule**: Performance of different adaptive CFG strategies
- **Statistical Significance**: Comprehensive evaluation with multiple seeds

## ï¿½ğŸ–¼ï¸ Results Showcase

### Quantitative Comparison

| Config      | Sampler | CFG 3   | CFG 5   | CFG 7   | CFG 10  | CFG 12  | CFG 15  | CFG 18  |
|-------------|---------|---------|---------|---------|---------|---------|---------|---------|
| DPM++ 2M    | dpm++   | 0.9951  | 0.9972  | 0.9985  | 0.9998  | 0.9999  | 0.9998  | 0.9997  |
| DDIM        | ddim    | 0.9948  | 0.9969  | 0.9982  | 0.9999  | 0.9999  | 0.9999  | 0.9998  |
| Euler A     | euler   | 0.9939  | 0.9961  | 0.9978  | 0.9997  | 0.9998  | 0.9997  | 0.9996  |
| HiResFix*   | --      |   --    |   --    |   --    | 0.9987  |   --    |   --    |   --    |
| RectifiedFlow* | --   |   --    |   --    |   --    | 0.9982  |   --    |   --    |   --    |

*Baselines from original papers; may not be directly comparable.

### Artifact vs. Stabilized Output

| High CFG (18): Artifact | Adaptive Schedule: Stabilized |
|:----------------------:|:-----------------------------:|
| ![Artifact](paper/figures/bad_high_cfg_artifact.png) | ![Stabilized](paper/figures/stabilized_output.png) |

*Left: Oversaturation and distortion at high CFG. Right: Clean, artifact-free output with adaptive guidance.*

### Sampler Comparison (Main Prompt)

| DDIM | DPM++ 2M | Euler A |
|:----:|:--------:|:-------:|
| ![DDIM](paper/figures/baseline_ddim_cfg10.0_512_prompt10_20250712_113447.png) | ![DPM++ 2M](paper/figures/baseline_dpm++_2m_cfg10.0_512_prompt10_20250712_114143.png) | ![Euler A](paper/figures/baseline_euler_a_cfg10.0_512_prompt10_20250712_113814.png) |

*All images: Prompt = "A space station orbiting Earth, sci-fi atmosphere", CFG=10*

## ğŸ“„ Citation
If you use this work, please cite:
```
@article{Sanjyal2024RectifiedHR,
  title={RectifiedHR: High-Resolution Diffusion via Energy Profiling and Adaptive Guidance Scheduling},
  author={Ankit Sanjyal},
  journal={arXiv preprint arXiv:XXXX.XXXXX},
  year={2024}
}
```

## ğŸ“š Paper
- [arXiv link (to be added)](https://arxiv.org/abs/XXXX.XXXXX)

## ğŸ“ License
This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ“‹ Quick Reference

### Common Commands
```bash
# Complete research reproduction
python master_runner.py

# Generate specific baseline  
python src/generate.py --prompt "test prompt" --cfg_scale 7.0 --resolution 512

# Run adaptive CFG experiment
python src/adaptive_cfg.py --schedule_type cosine_ramp --base_cfg 10.0

# Evaluate generated images
python src/enhanced_metrics.py --input_dir experiments/baseline

# Create research plots
python src/energy_profiling.py --data_dir experiments/adaptive_cfg
```

### Output Directories
- `experiments/baseline/` - Standard diffusion results (219 images)
- `experiments/adaptive_cfg/` - Adaptive CFG results (40 images)  
- `experiments/energy_plots/` - Research figures and analysis plots
- `experiments/revision_results/` - Enhanced experimental data
- `paper/figures/` - Curated images for publication

### Configuration Files
- `experiments/configuration_plan.json` - Complete experimental plan
- `experiments/comprehensive_results.json` - All experimental results
- `IMAGES_GUIDE.md` - Detailed guide to generated images

## ğŸ¤ Contributing
For questions or contributions, please open an issue or submit a pull request.
